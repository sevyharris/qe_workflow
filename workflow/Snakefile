# comment
import os
import glob
import snakemake


bulk_dir = "../results/bulk"
slab_dir = "../results/slab"
adsorbate_dir = "../results/adsorbate"
system_dir = "../results/system"

bulk_script = "scripts/bulk/relax_bulk.py"
lattice_constant_script = "scripts/bulk/lattice_constant.py"

slab_script = "scripts/relax_slab.py"
adsorbate_script = "scripts/relax_adsorbate.py"
coarse_system_script = "scripts/place_system.py"
# system_script = "scripts/relax_system.py"
run_bulk_script = "scripts/bulk/run_bulk.sh"
run_slab_script = "scripts/bulk/run_slab.sh"
run_adsorbate_script = "scripts/run_adsorbate.sh"
run_place_system_script = "scripts/run_place_system.sh"

metal = 'Cu'
rule calc_bulk_vc_relax:
    # Rule to compute the bulk constant using vc-relax
    # Subject to Pulay forces, so make sure you use a very high ecutwfc
    input:
        bulk_script
    output:
        "../results/bulk/bulk.pwo"
    conda:
        "envs/qe.yaml"
    shell:
        """
        mydir=$(pwd)
        mkdir -p {bulk_dir}
        cp {input} {bulk_dir}
        cp {run_bulk_script} {bulk_dir}
        cd {bulk_dir}
        sbatch --job-name={metal}_bulk run_bulk.sh
        cd $mydir
        """

make_lattice_converge_script = "scripts/bulk/make_lattice_convergence.py"
lattice_ecut_dir = os.path.join(bulk_dir, 'ecutwfc')
rule ecut_bulk_lattice:
    # Rule to use an equation of state with ecutwfc to check bulk lattice constant convergence
    input:
        make_lattice_converge_script
    conda:
        "envs/qe.yaml"
    shell:
        """
        mydir=$(pwd)
        mkdir -p {lattice_ecut_dir}
        python {make_lattice_converge_script} {lattice_ecut_dir}
        cd {lattice_ecut_dir}
        sbatch --job-name={metal}_ecut_bulk run_qe_jobs.sh
        cd $mydir
        """

rule relax_slab:
    input:
        rules.calc_bulk_vc_relax.output[0],
        slab_script
    output:
        "../results/slab/slab.pwo"
    conda:
        "envs/qe.yaml"
    shell:
        """
        mydir=$(pwd)
        mkdir -p {slab_dir}
        cp {rules.calc_bulk_vc_relax.output[0]} {slab_dir}
        cp {input[1]} {slab_dir}
        cp {run_slab_script} {slab_dir}
        cd {slab_dir}
        sbatch --job-name={metal}_slab run_slab.sh
        cd $mydir
        """

#adsorbate = "CO2"
#adsorbate = "CO"
#adsorbate = "CH4"
#adsorbate = "OH"
#adsorbate = "O2"
#adsorbate = "O"
#adsorbate = "H2"
#adsorbate = "H"
#adsorbate = "H2O"
#adsorbate = "C2H4"
#adsorbate = "N2"
adsorbate = config['adsorbate']
adsorbate_xyz = os.path.join('..', 'resources', 'adsorbates', adsorbate + '.xyz')
one_ads_dir = os.path.join(adsorbate_dir, adsorbate)
# Call with: snakemake -c1 --config adsorbate=H2O --use-conda relax_adsorbate
rule relax_adsorbate:
    input:
        adsorbate_xyz,
        adsorbate_script,
        run_adsorbate_script,
    #output:
    #    os.path.join(one_ads_dir, adsorbate + '.pwo')
    conda:
        "envs/qe.yaml"
    shell:
        """
        mydir=$(pwd)
        mkdir -p {one_ads_dir}
        cp {adsorbate_xyz} {one_ads_dir}
        cp {adsorbate_script} {one_ads_dir}
        cp {run_adsorbate_script} {one_ads_dir}
        cd {one_ads_dir}
        sbatch --job-name={adsorbate}_ads run_adsorbate.sh
        cd $mydir
        """


system_metal = "Cu111"
# system_ads = "CO2"
# system_ads = "CO"
# system_ads = "CH4"
# system_ads = "OH"
# system_ads = "O2"
# system_ads = "O"
# system_ads = "H2"
# system_ads = "H2O"
# system_ads = "C2H4"
# system_ads = "N2"
system_ads = "H"
system_site = "top"
system_str = '_'.join([system_metal, system_ads, system_site])
coarse_system_dir = os.path.join(system_dir, system_str + '_coarse')
adsorbate_pwo = os.path.join('..', 'results', 'adsorbate', system_ads, 'espresso.pwo')
slab_pwo = os.path.join('..', 'resources', 'slab.pwo')
# slab_pwo = os.path.join('..', 'results', 'slab', 'slab.pwo')
coarse_system_script = os.path.join('scripts', 'make_ads_height.py')
rule coarse_system:
    """Rule to place an adsorbate on a metal slab and run several energy jobs
    at multiple heights
    """
    input:
        adsorbate_pwo,
        slab_pwo,
        coarse_system_script,
    output:
        os.path.join(coarse_system_dir, 'espresso.pwo')
    conda:
        "envs/qe.yaml"
    shell:
        """
        mydir=$(pwd)
        mkdir -p {coarse_system_dir}
        cp {adsorbate_pwo} {coarse_system_dir}/adsorbate.pwo
        cp {slab_pwo} {coarse_system_dir}
        python {coarse_system_script} {coarse_system_dir}
        cd {coarse_system_dir}
        sbatch --job-name={system_ads}_system_coarse run_qe_jobs.sh
        cd $mydir
        """

fine_system_dir = os.path.join(system_dir, system_str)
fine_system_script = os.path.join('scripts', 'fine_system.py')
run_fine_system = os.path.join('scripts', 'run_system.sh')
rule fine_system:
    """Rule to optimize geometry of adsorbate on slab
    """
    input:
        adsorbate_pwo,
        slab_pwo,
        fine_system_script,
    output:
        os.path.join(fine_system_dir, 'espresso.pwo')
    conda:
        "envs/qe.yaml"
    shell:
        """
        mydir=$(pwd)
        mkdir -p {fine_system_dir}
        cp {fine_system_script} {fine_system_dir}
        cp {run_fine_system} {fine_system_dir}
        cp {adsorbate_pwo} {fine_system_dir}/adsorbate.pwo
        cp {slab_pwo} {fine_system_dir}
        cd {fine_system_dir}
        sbatch --job-name={system_ads}_system run_system.sh
        cd $mydir
        """

# TODO implement this
adsorbates = [
    'CO2',
    'CO',
    'CH4',
    'OH',
    'O',
    'H2',
    'H',
    'H2O',
    'C2H4',
    'N2'
]
adsorbate_xyz_dir = os.path.join('..', 'resources', 'adsorbates')
adsorbate_dirs = [os.path.join('..', 'results', 'adsorbate', ads) for ads in adsorbates]
rule relax_all_adsorbates:
    input:
        #glob.glob(os.path.join(adsorbate_xyz_dir, '*.xyz'))
        [os.path.join(adsorbate_xyz_dir, f'{ads}.xyz') for ads in adsorbates]
    #output:
    #    os.path.join(one_ads_dir, adsorbate + '.pwo')
    conda:
        "envs/qe.yaml"
    shell:
        """
        mydir=$(pwd)
        mkdir -p {adsorbate_dirs}
        #cp {input} {adsorbate_dirs}
        #cp {adsorbate_script} {adsorbate_dirs}
        #cp {run_adsorbate_script} {adsorbate_dirs}
        #cd {adsorbate_dirs}
        #sbatch --job-name={adsorbates}_ads run_adsorbate.sh
        #cd $mydir
        """


rule name_files:
    input:
        "../resources/adsorbates/{adsorbate_name}.xyz"
    #run:
    #    print(wildcards.adsorbate)
    shell:
        """
        cat {input[0]}
        #ls ../resources/adsorbates
        """

